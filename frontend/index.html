<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Startup Zero: Wish Tree</title>
    <style>
        body { font-family: 'Courier New', monospace; background-color: #f4f4f9; text-align: center; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Input & Button Group */
        .input-group { display: flex; gap: 10px; justify-content: center; margin-bottom: 20px; }
        input { padding: 12px; width: 60%; border: 2px solid #ddd; border-radius: 6px; font-size: 16px; }
        
        /* THE TWO BUTTONS */
        .btn { padding: 12px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; transition: 0.2s; }
        .btn-magic { background-color: #8e44ad; } /* Purple for AI */
        .btn-magic:hover { background-color: #732d91; }
        .btn-plant { background-color: #27ae60; } /* Green for Save */
        .btn-plant:hover { background-color: #219150; }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }

        ul { list-style: none; padding: 0; text-align: left; }
        li { background: #ecf0f1; margin: 10px 0; padding: 15px; border-left: 5px solid #27ae60; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸŒ³ The Wish Tree</h1>
        
        <div class="input-group">
            <input type="text" id="wish-input" placeholder="I want to be rich...">
        </div>
        
        <div class="input-group">
            <button class="btn btn-magic" id="polish-btn" onclick="polishWish()">âœ¨ Magic Polish</button>
            <button class="btn btn-plant" id="plant-btn" onclick="plantWish()">ðŸŒ± Plant Wish</button>
        </div>
        
        <h3>Growing Wishes:</h3>
        <ul id="wish-list"></ul>
    </div>

<script>
        // Application state and references
        const app = {
            // UI References
            inputEl: document.getElementById('wish-input'),
            polishBtn: document.getElementById('polish-btn'),
            polishTextEl: document.getElementById('polish-text'),
            plantBtn: document.getElementById('plant-btn'),
            wishListEl: document.getElementById('wish-list'),
            loadingSpinner: document.getElementById('loading-spinner'),
            notificationModal: document.getElementById('notification-modal'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            
            // --- CORE FUNCTIONALITY ---

            /**
             * Initializes the application by fetching and rendering existing wishes.
             */
            initApp: async function() {
                this.wishListEl.innerHTML = '<li class="p-4 text-gray-500 text-center">Fetching wishes from the Tree...</li>';
                
                try {
                    // Fetch existing wishes from our Node.js endpoint
                    const response = await fetch('/api/wishes'); 
                    if (!response.ok) throw new Error("Failed to fetch wishes.");
                    
                    const wishes = await response.json();
                    this.renderWishes(wishes);
                } catch (error) {
                    console.error("Error initializing app:", error);
                    this.showNotification('Error', 'Failed to load existing wishes from the server.', 'text-red-600');
                    this.wishListEl.innerHTML = '<li class="p-4 text-red-500 text-center">Server connection error.</li>';
                }
            },

            /**
             * Renders the list of wishes to the UI.
             * @param {Array} wishes - Assumes an array of { content: string, timestamp: number }
             */
            renderWishes: function(wishes) {
                if (wishes.length === 0) {
                    this.wishListEl.innerHTML = '<li class="p-4 text-gray-500 text-center">No wishes planted yet. Plant the first one!</li>';
                    return;
                }

                // Sort by timestamp (assuming our backend provides it)
                wishes.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                this.wishListEl.innerHTML = wishes.map(w => {
                    const date = w.timestamp ? new Date(w.timestamp) : new Date(); // Use existing timestamp
                    return `
                        <li class="wish-item p-4 rounded-lg shadow-sm flex justify-between items-center">
                            <span class="font-medium text-gray-800 flex-1">ðŸŒ± ${w.content}</span>
                            <span class="text-xs text-gray-400 ml-4">${date.toLocaleTimeString()}</span>
                        </li>
                    `;
                }).join('');
            },

            /**
             * Handles the "Magic Polish" button click to enhance the wish using our secure Node.js proxy.
             */
            polishWish: async function() {
                const initialWish = this.inputEl.value.trim();
                if (!initialWish) {
                    this.showNotification('Hold On', 'Please enter a wish first.', 'text-yellow-600');
                    return;
                }

                this.polishBtn.disabled = true;
                this.plantBtn.disabled = true;
                this.loadingSpinner.classList.remove('hidden');
                this.polishTextEl.textContent = "Casting...";

                try {
                    // *** API CALL: Route to our Node.js Backend Proxy ***
                    const response = await fetch('/api/polish', { 
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ wish: initialWish }) // Send wish payload to backend
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned status ${response.status}`);
                    }

                    const result = await response.json(); // Backend sends { polishedWish: "..." }
                    const polishedText = result.polishedWish?.trim();

                    if (polishedText) {
                        this.inputEl.value = polishedText;
                        this.inputEl.classList.remove('border-gray-300');
                        this.inputEl.classList.add('border-magic-purple'); 
                        this.showNotification('Magic Complete!', 'Your wish has been polished into a magnificent aspiration!', 'text-magic-purple');
                    } else {
                        throw new Error("AI returned no text content via backend.");
                    }

                } catch (err) {
                    console.error("Failed to polish wish:", err);
                    this.showNotification('Spell Failed', `The magic did not work: ${err.message}.`, 'text-red-600');
                } finally {
                    this.polishBtn.disabled = false;
                    this.plantBtn.disabled = false;
                    this.loadingSpinner.classList.add('hidden');
                    this.polishTextEl.textContent = "âœ¨ Magic Polish";
                }
            },

            /**
             * Handles the "Plant Wish" button click to save the wish to our SQLite database via Node.js.
             */
            plantWish: async function() {
                const wishContent = this.inputEl.value.trim();
                if (!wishContent) {
                    this.showNotification('Hold On', 'Please write a wish to plant.', 'text-yellow-600');
                    return;
                }

                this.plantBtn.disabled = true;
                this.plantBtn.textContent = "Planting...";

                try {
                    // *** API CALL: Route to our Node.js Backend Save Endpoint ***
                    const response = await fetch('/api/wishes', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ content: wishContent }) // Send content payload to backend
                    });

                    if (!response.ok) {
                        throw new Error(`Server returned status ${response.status}`);
                    }
                    
                    // Trigger a refresh after successful save
                    await this.initApp(); 

                    this.inputEl.value = ''; // Clear input
                    this.inputEl.classList.remove('border-magic-purple');
                    this.inputEl.classList.add('border-gray-300');
                    this.showNotification('Wish Planted!', 'Your wish is now growing in the tree.', 'text-plant-green');

                } catch (error) {
                    console.error("Error planting wish:", error);
                    this.showNotification('Failed to Plant', `Could not save the wish: ${error.message}.`, 'text-red-600');
                } finally {
                    this.plantBtn.disabled = false;
                    this.plantBtn.textContent = "ðŸŒ± Plant Wish";
                }
            },

            // --- UI/UTILITY FUNCTIONS (Kept from Refined Code) ---
            
            showNotification: function(title, message, titleClass) {
                // ... (Notification logic remains the same)
                this.notificationTitle.textContent = title;
                this.notificationTitle.className = `text-xl font-bold mb-3 ${titleClass}`;
                this.notificationMessage.textContent = message;
                this.notificationModal.classList.remove('hidden');
                this.notificationModal.classList.add('flex', 'opacity-0');
                setTimeout(() => this.notificationModal.classList.remove('opacity-0'), 10);
            },

            closeNotification: function() {
                // ... (Close logic remains the same)
                this.notificationModal.classList.add('opacity-0');
                setTimeout(() => this.notificationModal.classList.remove('flex'), 300);
                setTimeout(() => this.notificationModal.classList.add('hidden'), 300);
            }
        };

        // Expose app functions globally for inline onclick handlers
        window.app = app;

        // Initialize the application once the window loads
        window.onload = app.initApp.bind(app);
    </script>
</body>
</html>