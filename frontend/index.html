<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>ðŸŒ³ The Wish Tree</title>
Â  Â  Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  /* Custom styles for better aesthetics */
Â  Â  Â  Â  body { font-family: 'Inter', sans-serif; background-color: #f0fdf4; }
Â  Â  Â  Â  .wish-item {
Â  Â  Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  Â  Â  border-left: 4px solid #10b981; /* Emerald green accent */
Â  Â  Â  Â  Â  Â  transition: all 0.3s ease;
Â  Â  Â  Â  }
Â  Â  Â  Â  .wish-item:hover {
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 10px rgba(16, 185, 129, 0.2);
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  }
Â  Â  </style>
Â  Â  <script>
Â  Â  Â  Â  tailwind.config = {
Â  Â  Â  Â  Â  Â  theme: {
Â  Â  Â  Â  Â  Â  Â  Â  extend: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  colors: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'magic-purple': '#8e44ad',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'plant-green': '#27ae60',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
</head>
<body>
Â  Â  <div id="app" class="min-h-screen flex items-start justify-center p-4 sm:p-8">
Â  Â  Â  Â  <div class="w-full max-w-xl bg-white p-6 sm:p-10 rounded-xl shadow-2xl border border-gray-100 mt-10">
Â  Â  Â  Â  Â  Â  <h1 class="text-3xl sm:text-4xl font-extrabold text-center text-gray-800 mb-2">
Â  Â  Â  Â  Â  Â  Â  Â  ðŸŒ³ The Wish Tree
Â  Â  Â  Â  Â  Â  </h1>
Â  Â  Â  Â  Â  Â  <p class="text-center text-sm text-gray-500 mb-8">Polish your dreams with AI magic and plant them for growth.</p>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="wish-input" placeholder="Enter your wish (e.g., I want a better job)..."
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg text-gray-700 focus:outline-none focus:ring-2 focus:ring-plant-green transition duration-200">

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="polish-btn" onclick="app.polishWish()" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex-1 flex items-center justify-center p-3 sm:p-4 bg-magic-purple hover:bg-opacity-90 text-white font-semibold rounded-lg shadow-md transition duration-200 disabled:bg-gray-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="polish-text">âœ¨ Magic Polish</span> 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="plant-btn" onclick="app.plantWish()" 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="flex-1 flex items-center justify-center p-3 sm:p-4 bg-plant-green hover:bg-opacity-90 text-white font-semibold rounded-lg shadow-md transition duration-200 disabled:bg-gray-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸŒ± Plant Wish
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="loading-spinner" class="mt-8 text-center hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="animate-spin inline-block w-8 h-8 border-4 border-magic-purple border-t-transparent rounded-full" role="status"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-magic-purple mt-2 text-sm">Casting the spell...</p>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-700 mt-10 mb-4 border-b pb-2">Growing Wishes:</h3>
Â  Â  Â  Â  Â  Â  <ul id="wish-list" class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  <li class="p-4 text-gray-500 text-center">Loading wishes...</li>
Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="notification-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center p-4 transition-opacity duration-300" onclick="app.closeNotification()">
Â  Â  Â  Â  <div class="bg-white p-6 rounded-lg shadow-2xl max-w-sm w-full transform scale-95 transition-transform duration-300" onclick="event.stopPropagation()">
Â  Â  Â  Â  Â  Â  <h4 id="notification-title" class="text-xl font-bold mb-3 text-red-600">Error</h4>
Â  Â  Â  Â  Â  Â  <p id="notification-message" class="text-gray-700 mb-4"></p>
Â  Â  Â  Â  Â  Â  <button class="w-full py-2 bg-plant-green text-white font-semibold rounded-lg hover:bg-opacity-90" onclick="app.closeNotification()">
Â  Â  Â  Â  Â  Â  Â  Â  Understood
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <script>
Â  Â  Â  Â  // Application state and references
Â  Â  Â  Â  const app = {
Â  Â  Â  Â  Â  Â  // UI References
Â  Â  Â  Â  Â  Â  inputEl: document.getElementById('wish-input'),
Â  Â  Â  Â  Â  Â  polishBtn: document.getElementById('polish-btn'),
Â  Â  Â  Â  Â  Â  // Use the new span reference
Â  Â  Â  Â  Â  Â  polishTextEl: document.getElementById('polish-text'), 
Â  Â  Â  Â  Â  Â  plantBtn: document.getElementById('plant-btn'),
Â  Â  Â  Â  Â  Â  wishListEl: document.getElementById('wish-list'),
Â  Â  Â  Â  Â  Â  // Restore the spinner and modal references
Â  Â  Â  Â  Â  Â  loadingSpinner: document.getElementById('loading-spinner'), 
Â  Â  Â  Â  Â  Â  notificationModal: document.getElementById('notification-modal'),
Â  Â  Â  Â  Â  Â  notificationTitle: document.getElementById('notification-title'),
Â  Â  Â  Â  Â  Â  notificationMessage: document.getElementById('notification-message'),
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // --- CORE FUNCTIONALITY ---
			
			clientId: null, // Property to store the persistent ID
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Ensures a stable, unique ID exists for the user.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  getOrCreateClientId: function() {
Â  Â  Â  Â  Â  Â  Â  Â  let id = localStorage.getItem('wishTreeClientId');
Â  Â  Â  Â  Â  Â  Â  Â  if (!id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id = 'WISH-' + Math.random().toString(36).substring(2, 15) + Date.now().toString(36);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  localStorage.setItem('wishTreeClientId', id);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  this.clientId = id;
Â  Â  Â  Â  Â  Â  Â  Â  return id;
Â  Â  Â  Â  Â  Â  },
			
Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Initializes the application by getting ClientID and fetching wishes.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  initApp: async function() {
Â  Â  Â  Â  Â  Â  Â  Â  this.getOrCreateClientId(); // FIXED: Must be called first
Â  Â  Â  Â  Â  Â  Â  Â  this.wishListEl.innerHTML = '<li class="p-4 text-gray-500 text-center">Fetching wishes from the Tree...</li>';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fetch existing wishes from our Node.js endpoint
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/wishes');Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error("Failed to fetch wishes.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const wishes = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.renderWishes(wishes);
Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error initializing app:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Use the new modal for errors
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('Error', 'Failed to load existing wishes from the server.', 'text-red-600'); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.wishListEl.innerHTML = '<li class="p-4 text-red-500 text-center">Server connection error.</li>';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Renders the list of wishes to the UI.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  renderWishes: function(wishes) {
Â  Â  Â  Â  Â  Â  Â  Â  if (wishes.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.wishListEl.innerHTML = '<li class="p-4 text-gray-500 text-center">No wishes planted yet. Plant the first one!</li>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

				// Sort by createdAt (latest first). Uses the corrected backend field.
				wishes.sort((a, b) => {
					const dateA = new Date(a.createdAt).getTime();
					const dateB = new Date(b.createdAt).getTime();
					return dateB - dateA; // Descending order
				});

Â  Â  Â  Â  Â  Â  Â  Â  this.wishListEl.innerHTML = wishes.map(w => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = new Date(w.createdAt);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="wish-item p-4 rounded-lg shadow-sm flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-medium text-gray-800 flex-1">ðŸŒ± ${w.content}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xs text-gray-400 ml-4">${date.toLocaleTimeString()} (${date.toLocaleDateString()})</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Handles the "Magic Polish" button click.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  polishWish: async function() {
Â  Â  Â  Â  Â  Â  Â  Â  const initialWish = this.inputEl.value.trim();
				const clientId = this.clientId; 
Â  Â  Â  Â  Â  Â  Â  Â  if (!initialWish) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('Hold On', 'Please enter a wish first.', 'text-yellow-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  this.polishBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  this.plantBtn.disabled = true;
                // Safely show loading indicator
Â  Â  Â  Â  Â  Â  Â  Â  this.loadingSpinner.classList.remove('hidden'); 
Â  Â  Â  Â  Â  Â  Â  Â  this.polishTextEl.textContent = "Casting...";

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Route to secure Node.js Backend Proxy
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/polish', {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Sending anonymousId for future rate limiting!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ content: initialWish, anonymousId: clientId }) 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Server returned status ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const polishedText = result.polished?.trim(); // Backend uses 'polished'

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (polishedText) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.inputEl.value = polishedText;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Visual cue restored
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.inputEl.classList.add('border-magic-purple'); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('Magic Complete!', 'Your wish has been polished into a magnificent aspiration!', 'text-magic-purple');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("AI returned no text content via backend.");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to polish wish:", err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('Spell Failed', `The magic did not work: ${err.message}.`, 'text-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.polishBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.plantBtn.disabled = false;
                    // Safely hide loading indicator
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.loadingSpinner.classList.add('hidden'); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.polishTextEl.textContent = "âœ¨ Magic Polish";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  /**
Â  Â  Â  Â  Â  Â  Â * Handles the "Plant Wish" button click.
Â  Â  Â  Â  Â  Â  Â */
Â  Â  Â  Â  Â  Â  plantWish: async function() {
Â  Â  Â  Â  Â  Â  Â  Â  const wishContent = this.inputEl.value.trim();
				const clientId = this.clientId; 
Â  Â  Â  Â  Â  Â  Â  Â  if (!wishContent) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('Hold On', 'Please write a wish to plant.', 'text-yellow-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  this.plantBtn.disabled = true;
Â  Â  Â  Â  Â  Â  Â  Â  this.plantBtn.textContent = "Planting...";

Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Route to Node.js Backend Save Endpoint
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/wishes', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Sending anonymousId for saving!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ content: wishContent, anonymousId: clientId }) 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Server returned status ${response.status}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await this.initApp();Â // Refresh list

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.inputEl.value = ''; // Clear input
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Restore neutral visual state
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.inputEl.classList.remove('border-magic-purple');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.inputEl.classList.add('border-gray-300');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('Wish Planted!', 'Your wish is now growing in the tree.', 'text-plant-green');

Â  Â  Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error planting wish:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.showNotification('Failed to Plant', `Could not save the wish: ${error.message}.`, 'text-red-600');
Â  Â  Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.plantBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  this.plantBtn.textContent = "ðŸŒ± Plant Wish";
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  // --- UI/UTILITY FUNCTIONS ---
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showNotification: function(title, message, titleClass) {
Â  Â  Â  Â  Â  Â  Â  Â  this.notificationTitle.textContent = title;
Â  Â  Â  Â  Â  Â  Â  Â  // Removed Tailwind-specific class prefixes to avoid duplication errors on class replacement
Â  Â  Â  Â  Â  Â  Â  Â  this.notificationTitle.className = `text-xl font-bold mb-3 ${titleClass}`; 
Â  Â  Â  Â  Â  Â  Â  Â  this.notificationMessage.textContent = message;
Â  Â  Â  Â  Â  Â  Â  Â  this.notificationModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  this.notificationModal.classList.add('flex', 'opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => this.notificationModal.classList.remove('opacity-0'), 10);
Â  Â  Â  Â  Â  Â  },

Â  Â  Â  Â  Â  Â  closeNotification: function() {
Â  Â  Â  Â  Â  Â  Â  Â  this.notificationModal.classList.add('opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => this.notificationModal.classList.remove('flex'), 300);
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => this.notificationModal.classList.add('hidden'), 300);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  // Expose app functions globally for inline onclick handlers
Â  Â  Â  Â  window.app = app;

Â  Â  Â  Â  // Initialize the application once the window loads
Â  Â  Â  Â  window.onload = app.initApp.bind(app);
Â  Â  </script>
</body>
</html>